<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapeamento Separtec</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family: Calibri, sans-serif; }
    #map { height:100vh; width:100vw; }

    /* Painel de ambientes (rádio) no canto superior direito */
    #ambientes-panel {
      position: fixed;
      top: 10px; right: 10px;
      width: 200px; max-height: 50vh; overflow-y: auto;
      padding: 10px; background: rgba(255,255,255,0.9);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      border-radius: 5px; font-size: small; z-index: 1000;
    }
    #ambientes-panel strong { display:block; margin-bottom:8px; }
    #ambientes-panel label { display:flex; align-items:center; margin-bottom:4px; }
    #ambientes-panel input[type="radio"] { margin-right:6px; }

    /* Painel de municípios (checkbox) no canto inferior direito */
    #info-panel {
      position: fixed;
      bottom: 10px; right: 10px;
      width: 200px; max-height: 50vh; overflow-y: auto;
      padding: 10px; background: rgba(255,255,255,0.9);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      border-radius: 5px; font-size: small; z-index: 1000;
    }
    #info-panel strong { display:block; margin-bottom:8px; }
    #info-panel label { display:flex; align-items:center; margin-bottom:4px; }
    #info-panel input[type="checkbox"] { margin-right:6px; }

    /* Estilo para círculos de contagem */
    .count-label {
      width: 30px; height: 30px;
      font-size: 14px; font-weight: bold;
      background: #fff; border: 2px solid #000;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Painel de seleção de ambientes -->
  <div id="ambientes-panel">
    <strong>Selecione o ambiente de inovação:</strong>
    <div id="ambientes-list"></div>
  </div>

  <!-- Painel de seleção de municípios -->
  <div id="info-panel">
    <strong>Selecione as cidades:</strong>
    <div id="checkbox-list"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Dados iniciais ---
    const municipiosOeste = [
      "ANAHY","ASSIS CHATEAUBRIAND","BOA VISTA DA APARECIDA","BRAGANEY",
      "BRASILÂNDIA DO SUL","CAFELÂNDIA","CAPITÃO LEÔNIDAS MARQUES","CASCAVEL",
      "CÉU AZUL","CORBÉLIA","DIAMANTE D´OESTE","ENTRE RIOS DO OESTE",
      "FORMOSA DO OESTE","FOZ DO IGUAÇU","FRANCISCO ALVES","GUAÍRA",
      "IGUATU","IRACEMA DO OESTE","ITAIPULÂNDIA","JESUÍTAS",
      "LINDOESTE","MARECHAL CÂNDIDO RONDON","MARIPÁ","MATELÂNDIA",
      "MEDIANEIRA","MERCEDES","MISSAL","NOVA AURORA",
      "NOVA SANTA ROSA","OURO VERDE DO OESTE","PALOTINA","PATO BRAGADO",
      "QUATRO PONTES","RAMILÂNDIA","SANTA HELENA","SANTA LÚCIA",
      "SANTA TEREZA DO OESTE","SANTA TEREZINHA DE ITAIPU","SÃO JOSÉ DAS PALMEIRAS",
      "SÃO MIGUEL DO IGUAÇU","SÃO PEDRO DO IGUAÇU","SERRANÓPOLIS DO IGUAÇU",
      "TERRA ROXA","TOLEDO","TUPÃSSI","UBIRATÃ","VERA CRUZ DO OESTE"
    ];
    const rainbowColors = [
      "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231",
      "#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe",
      "#008080","#e6beff","#9a6324","#fffac8","#800000",
      "#aaffc3","#808000","#ffd8b1","#000075","#808080"
    ];
    const offsetsMap = {
      "FOZ DO IGUAÇU":[0.005,-0.09],
      "MARECHAL CÂNDIDO RONDON":[0.02,0.05],
      "PALOTINA":[0.02,-0.02],
      "TOLEDO":[0.02,0.02],
      "CASCAVEL":[0.02,0.02]
    };

    let prGeoJsonData = null;
    let municipiosMap = {};
    let municipiosComAmbientes = new Set();
    let countsMap = {};
    let areaCountsMap = {};      // muni -> { area -> count }
    let muniAmbientesMap = {};
    let ambientesSet = new Set();

    let selectedMunicipios = new Set();
    let markersMap = {};

    let environmentColorMapping = {};
    let selectedAmbiente = 'TODOS';
    let envMarkersMap = {};      // muni -> marker for environment count

    // --- Inicializa o mapa ---
    const map = L.map('map').setView([-24.905,-53.8733],9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Carrega dados ---
    fetch('dados_separtec_final.json')
      .then(r=>r.json())
      .then(data=>{
        data.forEach(item=>{
          const muni = item.MUNICÍPIO.toUpperCase();
          const area = item["ÁREA TEMÁTICA/CONHECIMENTO"];
          ambientesSet.add(area);
          if (municipiosOeste.includes(muni)) {
            municipiosComAmbientes.add(muni);
            countsMap[muni] = (countsMap[muni]||0)+1;
            areaCountsMap[muni] = areaCountsMap[muni]||{};
            areaCountsMap[muni][area] = (areaCountsMap[muni][area]||0)+1;
            (muniAmbientesMap[muni]||(muniAmbientesMap[muni]=[])).push(area);
          }
        });
        // cores para cada ambiente
        [...ambientesSet].sort().forEach((area,i)=>{
          environmentColorMapping[area] = rainbowColors[i%rainbowColors.length];
        });
        populateAmbientesRadios();
        populateMunicipioCheckboxes();
      });

    // --- Carrega GeoJSON ---
    fetch('municipios-pr.json')
      .then(r=>r.json())
      .then(data=>{
        prGeoJsonData = data;
        L.geoJSON(prGeoJsonData,{
          style: f=>{
            const n=f.properties.name.toUpperCase();
            const ok=municipiosComAmbientes.has(n);
            return {
              color:'#000', weight:1,
              fillColor: ok?'#FF69B4':'#ccc',
              fillOpacity: ok?0.5:0.3
            };
          },
          onEachFeature:(f,layer)=>{
            const n=f.properties.name.toUpperCase();
            municipiosMap[n]=layer;
            layer.on('click',()=>{
              if(!municipiosComAmbientes.has(n))return;
              toggleMunicipio(n);
              const cb=document.getElementById('chk_'+slug(n));
              if(cb) cb.checked = selectedMunicipios.has(n);
            });
          }
        }).addTo(map);
      });

    // --- Popula rádios de ambientes ---
    function populateAmbientesRadios(){
      const ctr=document.getElementById('ambientes-list');
      // "TODOS"
      let lbl=document.createElement('label'),
          rd=document.createElement('input');
      rd.type='radio'; rd.name='amb'; rd.value='TODOS'; rd.checked=true;
      rd.addEventListener('change',updateEnvironment);
      lbl.appendChild(rd); lbl.append('TODOS'); ctr.appendChild(lbl);
      ctr.appendChild(Object.assign(document.createElement('div'),{style:'height:8px'}));
      // cada ambiente
      [...ambientesSet].sort().forEach(area=>{
        let l=document.createElement('label'),
            r=document.createElement('input');
        r.type='radio'; r.name='amb'; r.value=area;
        r.addEventListener('change',updateEnvironment);
        l.appendChild(r); l.append(area);
        ctr.appendChild(l);
      });
    }

    // --- Popula checkboxes de municípios ---
    function populateMunicipioCheckboxes(){
      const ctr=document.getElementById('checkbox-list');
      // Checkbox "TODOS"
      let lbl=document.createElement('label'),
          cb=document.createElement('input');
      cb.type='checkbox'; cb.id='chk_TODOS_M';
      cb.addEventListener('change',()=>{
        const on=cb.checked;
        municipiosComAmbientes.forEach(m=>{
          let c=document.getElementById('chk_'+slug(m));
          if(on){ selectMunicipio(m); if(c) c.checked=true; }
          else { deselectMunicipio(m); if(c) c.checked=false; }
        });
      });
      lbl.appendChild(cb); lbl.append('TODOS'); ctr.appendChild(lbl);
      ctr.appendChild(Object.assign(document.createElement('div'),{style:'height:8px'}));
      // individuais
      [...municipiosComAmbientes].sort().forEach(m=>{
        let lm=document.createElement('label'),
            cm=document.createElement('input');
        cm.type='checkbox'; cm.id='chk_'+slug(m);
        cm.addEventListener('change',()=>{
          cm.checked?selectMunicipio(m):deselectMunicipio(m);
        });
        lm.appendChild(cm); lm.append(m); ctr.appendChild(lm);
      });
    }

    // --- Atualiza ambiente selecionado e marcadores ---
    function updateEnvironment(){
      selectedAmbiente = document.querySelector('input[name="amb"]:checked').value;
      clearMunicipios();              // limpa seleções de usuário
      clearEnvMarkers();              // remove marcadores antigos
      // aplica cor aos polígonos
      municipiosComAmbientes.forEach(m=>{
        const lyr = municipiosMap[m];
        if(!lyr) return;
        if(selectedAmbiente==='TODOS'){
          lyr.setStyle({ fillColor:'#FF69B4', fillOpacity:0.5 });
        } else {
          const has = (areaCountsMap[m]||{})[selectedAmbiente] > 0;
          if(has){
            lyr.setStyle({
              fillColor:environmentColorMapping[selectedAmbiente],
              fillOpacity:0.7
            });
            // adiciona marcador de contagem desse ambiente
            addEnvCountMarker(m);
          } else {
            lyr.setStyle({ fillOpacity: 0 });
          }
        }
      });
    }

    // --- Marcadores de contagem de MUNICÍPIO ---
    function addCountMarker(m){
      if(markersMap[m]) return;
      const lyr = municipiosMap[m];
      if(!lyr) return;
      let pos = lyr.getBounds().getCenter();
      if(offsetsMap[m]) pos=L.latLng(pos.lat+offsetsMap[m][0], pos.lng+offsetsMap[m][1]);
      const icon = L.divIcon({
        className:'', html:`<div class="count-label">${countsMap[m]||0}</div>`,
        iconAnchor:[15,15]
      });
      markersMap[m] = L.marker(pos,{icon}).addTo(map);
    }
    function removeCountMarker(m){
      if(markersMap[m]){
        map.removeLayer(markersMap[m]);
        delete markersMap[m];
      }
    }

    // --- Marcadores de contagem de AMBIENTE ---
    function addEnvCountMarker(m){
      if(envMarkersMap[m]) return;
      const lyr = municipiosMap[m];
      if(!lyr) return;
      let pos = lyr.getBounds().getCenter();
      if(offsetsMap[m]) pos=L.latLng(pos.lat+offsetsMap[m][0], pos.lng+offsetsMap[m][1]);
      const cnt = (areaCountsMap[m]||{})[selectedAmbiente] || 0;
      const icon = L.divIcon({
        className:'', html:`<div class="count-label">${cnt}</div>`,
        iconAnchor:[15,15]
      });
      envMarkersMap[m] = L.marker(pos,{icon}).addTo(map);
    }
    function clearEnvMarkers(){
      Object.values(envMarkersMap).forEach(mr => map.removeLayer(mr));
      envMarkersMap = {};
    }

    // --- Seleção de municípios ---
    function selectMunicipio(m){
      if(!selectedMunicipios.has(m)){
        selectedMunicipios.add(m);
        const lyr = municipiosMap[m];
        lyr && lyr.setStyle({ fillColor:'yellow', fillOpacity:0.7 });
        addCountMarker(m);
      }
    }
    function deselectMunicipio(m){
      if(selectedMunicipios.has(m)){
        selectedMunicipios.delete(m);
        const lyr = municipiosMap[m];
        if(lyr){
          removeCountMarker(m);
          // restaura cor de acordo com ambiente ativo
          if(selectedAmbiente==='TODOS'){
            lyr.setStyle({ fillColor:'#FF69B4', fillOpacity:0.5 });
          } else {
            const has = (areaCountsMap[m]||{})[selectedAmbiente] > 0;
            if(has){
              lyr.setStyle({
                fillColor:environmentColorMapping[selectedAmbiente],
                fillOpacity:0.7
              });
            } else {
              lyr.setStyle({ fillOpacity: 0 });
            }
          }
        }
      }
    }
    function toggleMunicipio(m){
      selectedMunicipios.has(m)?deselectMunicipio(m):selectMunicipio(m);
    }
    function clearMunicipios(){
      document.getElementById('chk_TODOS_M').checked = false;
      document.querySelectorAll('#checkbox-list input[type=checkbox]').forEach(cb=>{
        if(cb.id!=='chk_TODOS_M') cb.checked = false;
      });
      [...selectedMunicipios].forEach(deselectMunicipio);
    }

    // --- Utilitário para IDs ---
    function slug(txt){
      return txt.toUpperCase().replace(/\s+/g,'_').replace(/[^A-Z0-9_]/g,'');
    }
  </script>
</body>
</html>
